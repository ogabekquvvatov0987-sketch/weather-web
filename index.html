<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Weather App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* Umumiy reset (barcha elementlar uchun) */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    /* Default fon (Quyoshli osmon) */
    /* --bg-image is deprecated, using video now */
    --text-color: #fff;
    --glass-bg: rgba(255, 255, 255, 0.1); /* Slightly less opaque */
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    --input-bg: rgba(0, 0, 0, 0.2);
    --btn-bg: rgba(255, 255, 255, 0.2); /* Slightly more opaque */
    --btn-hover: rgba(255, 255, 255, 0.3);
}

body.dark-mode {
    /* Tun rejimi */
    --text-color: #e0e0e0;
    --glass-bg: rgba(0, 0, 0, 0.5); /* Slightly less opaque */
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.7);
    --input-bg: rgba(0, 0, 0, 0.4);
    --btn-bg: rgba(0, 0, 0, 0.3); /* Slightly more opaque */
    --btn-hover: rgba(255, 255, 255, 0.2);
}

html, body {
    width: 100%;
    height: 100%;
    overflow-x: hidden; /* Gorizontal scrollni oldini olish */
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #000; /* Video yuklanmaguncha qora fon */
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-color);
    transition: background 1s ease-in-out;
}

/* Animated Video Background */
#bg-video {
    position: fixed;
    right: 0;
    bottom: 0;
    min-width: 100%;
    min-height: 100%;
    width: auto;
    height: auto;
    z-index: -100;
    filter: blur(8px); /* Orqa fonni xiralashtirish */
    transform: scale(1.2); /* Xiralashgan chetlarni yopish uchun kattalashtirildi */
    object-fit: cover;
    transition: opacity 3s ease-in-out; /* Almashish yanada sekinlashtirildi */
    will-change: opacity; /* Optimizatsiya */
}

/* Asosiy konteyner (Device wrapper) */
#app-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    position: relative;
    overflow: hidden;
}

/* Telefon rejimi */
#app-wrapper.mobile-mode {
    width: 375px;
    height: 812px;
    border-radius: 40px;
    border: 12px solid #333;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    overflow-y: auto; /* Scroll bo'lishi uchun */
}

/* Telefon rejimida ichki elementlarni moslashtirish */
#app-wrapper.mobile-mode .card {
    width: 85%; /* Kichikroq kenglik */
    padding: 15px;
    margin-top: 40px; /* Tepadan joy */
}
#app-wrapper.mobile-mode h1 { font-size: 28px; margin: 5px 0; }
#app-wrapper.mobile-mode h2 { font-size: 18px; margin-bottom: 10px; }
#app-wrapper.mobile-mode input { width: 100%; font-size: 14px; padding: 10px; box-sizing: border-box; }
#app-wrapper.mobile-mode button { font-size: 14px; padding: 10px 15px; }
#app-wrapper.mobile-mode .details-grid { grid-template-columns: 1fr; gap: 5px; font-size: 13px; }
#app-wrapper.mobile-mode .input-group { flex-direction: row; width: 100%; }

/* Glassmorphism Card */
.card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    padding: 30px;
    border-radius: 25px;
    text-align: center;
    width: 90%;
    max-width: 320px;
    transition: all 0.3s ease;
}

h1 { margin: 10px 0; font-size: 40px; font-weight: 700; }
h2 { margin-bottom: 20px; font-weight: 600; }

.input-group {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
    width: 100%;
}

input {
    padding: 12px;
    width: 60%;
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    background: var(--input-bg);
    color: #fff;
    outline: none;
    font-size: 16px;
    transition: 0.3s;
}
input::placeholder { color: var(--text-color); opacity: 0.7; }

button {
    padding: 12px 25px;
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    background: var(--btn-bg);
    color: white;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    backdrop-filter: blur(10px); /* Shaffoflikni oshirish */
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}
button:hover { background: var(--btn-hover); transform: translateY(-2px); }
button:active { transform: scale(0.95); transform: translateY(0); }

.location-btn {
    background: var(--btn-bg);
    padding: 12px;
}

/* Sozlamalar Tugmasi */
.settings-toggle {
    position: fixed;
    right: 20px;
    bottom: 20px; /* Yana pastga tushirildi */
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-color);
    font-size: 24px;
    cursor: pointer;
    z-index: 1001;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(10px);
    box-shadow: var(--glass-shadow);
    transition: transform 0.3s, background 0.3s;
}
.settings-toggle:hover {
    transform: rotate(90deg);
    background: var(--btn-hover);
}

/* Sozlamalar Paneli (Sidebar) */
.settings-panel {
    position: fixed;
    left: 50%;
    transform: translateX(-50%) translateY(20px); /* Markazlashtirish */
    bottom: 80px; /* Tugma ustida, ozroq pastga */
    width: 90%;
    max-width: 500px;
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    padding: 15px;
    border-radius: 20px;
    border: 1px solid var(--glass-border);
    display: flex;
    flex-direction: row; /* Gorizontal */
    flex-wrap: wrap;
    justify-content: space-around;
    gap: 10px;
    z-index: 1000;
    box-shadow: var(--glass-shadow);
    /* Yashirish uchun */
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.settings-panel.active {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}

.settings-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1;
    min-width: 80px;
    align-items: center;
}

.settings-label {
    font-size: 12px;
    opacity: 0.8;
    text-align: center;
}

.icon-btn {
    background: rgba(255,255,255,0.2);
    padding: 8px;
    border-radius: 10px;
    font-size: 14px;
    width: 100%;
}
.icon-btn.active {
    background: rgba(46, 204, 113, 0.8); /* Yashil rang (aktiv holat) */
    border: 1px solid #2ecc71;
    color: white;
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Moslashuvchan ustunlar */
    gap: 10px;
    margin-top: 20px;
    font-size: 14px;
    text-align: left;
    background: rgba(0,0,0,0.2);
    padding: 15px;
    border-radius: 15px;
}

/* Magnit bo'roni uchun */
.geomagnetic-storm {
    margin-top: 15px;
    padding: 10px;
    background: rgba(255, 165, 0, 0.2); /* Ogohlantiruvchi rang */
    border: 1px solid rgba(255, 165, 0, 0.5);
    border-radius: 10px;
    font-size: 13px;
    font-weight: bold;
    text-align: center;
    display: none; /* By default hidden */
}

/* Mobil qurilmalar uchun moslashtirish (Responsive) */
@media (max-width: 768px) {
    body {
        font-size: 16px;
        align-items: flex-start; /* Elementlarni tepadan joylashtirish */
        padding-top: 20px;
    }
    
    .card {
        width: 95%;
        max-width: 100%;
        padding: 20px;
    }

    input, button {
        width: 100%;
        padding: 12px;
    }

    /* Qidiruv qatori uchun maxsus qoida (yonma-yon turishi uchun) */
    .input-group input {
        width: auto;
        flex: 1;
    }
    .input-group button {
        width: auto;
    }

    /* Mobil rejimda simulator ramkasini olib tashlash (haqiqiy telefonda) */
    #app-wrapper.mobile-mode {
        width: 100%;
        height: auto;
        border: none;
        border-radius: 0;
        box-shadow: none;
        overflow-y: visible;
    }
}

/* LOADING SCREEN */
#loader-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    transition: opacity 0.5s ease, visibility 0.5s;
}

.loader-content {
    text-align: center;
    color: white;
}

.progress-circle {
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(#00f2fe var(--progress), rgba(255,255,255,0.1) 0deg);
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 20px auto;
    box-shadow: 0 0 20px rgba(0, 242, 254, 0.5);
}

.progress-circle::before {
    content: "";
    position: absolute;
    width: 100px;
    height: 100px;
    background: #1e3c72; /* Loader foni bilan bir xil */
    border-radius: 50%;
}

.progress-text {
    position: relative;
    font-size: 24px;
    font-weight: bold;
    z-index: 1;
}

.loading-msg {
    font-size: 18px;
    opacity: 0.9;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}
</style>
</head>
<body>

<!-- Animated Video Background -->
<video autoplay loop playsinline muted id="bg-video">
    <!-- Source JS orqali boshqariladi, ovoz boshida o'chirilgan -->
</video>

<!-- Loading Screen -->
<div id="loader-wrapper">
    <div class="loader-content">
        <div class="progress-circle" id="progressCircle" style="--progress: 0deg;">
            <span class="progress-text" id="progressText">0%</span>
        </div>
        <p class="loading-msg">Sahifa yuklanmoqda, iltimos kuting...</p>
    </div>
</div>

<!-- Sozlamalar Tugmasi -->
<button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</button>

<!-- Sozlamalar Paneli -->
<div class="settings-panel" id="settingsPanel">
    <div class="settings-group">
        <span class="settings-label" id="lbl_device">Qurilma</span>
        <button class="icon-btn" onclick="setDevice('desktop')" id="btn_desktop">üíª</button>
        <button class="icon-btn" onclick="setDevice('mobile')" id="btn_mobile">üì±</button>
    </div>
    <div class="settings-group">
        <span class="settings-label" id="lbl_theme">Mavzu</span>
        <button class="icon-btn" onclick="setTheme('light')" id="btn_light">‚òÄÔ∏è</button>
        <button class="icon-btn" onclick="setTheme('dark')" id="btn_dark">üåô</button>
    </div>
    <div class="settings-group">
        <span class="settings-label" id="lbl_lang">Til</span>
        <button class="icon-btn" onclick="setLang('uz')" id="btn_lang_uz">üá∫üáø UZ</button>
        <button class="icon-btn" onclick="setLang('ru')" id="btn_lang_ru">üá∑üá∫ RU</button>
        <button class="icon-btn" onclick="setLang('en')" id="btn_lang_en">üá¨üáß EN</button>
    </div>

</div>

<!-- Asosiy Ilova -->
<div id="app-wrapper">
    <div class="card">
        <h2 id="app_title">üå§ Ob-havo</h2>
        <div class="input-group">
            <input type="text" id="city" placeholder="Shahar nomi">
            <button class="location-btn" onclick="getLocation()" id="btn_loc">üìç</button>
        </div>
        <button onclick="getWeather()" id="btn_check">Ko‚Äòrish</button>
        <div id="result"></div>
        <div class="geomagnetic-storm" id="geomagnetic-storm-info"></div>
    </div>
</div>

<script>
// API kalitni URL parametridan olish (Bot orqali yuboriladi)
const urlParams = new URLSearchParams(window.location.search);
let apiKey = urlParams.get('api_key');

// Global variables to store current weather info
let currentWeatherConditionText = "";
let currentWeatherIsDay = true; // Default to day

// --- LOADING LOGIC (5 soniya) ---
document.addEventListener("DOMContentLoaded", () => {
    const loader = document.getElementById('loader-wrapper');
    const progressCircle = document.getElementById('progressCircle');
    const progressText = document.getElementById('progressText');

    // Initialize theme state first
    const savedThemeState = localStorage.getItem('isDarkMode');
    const isDarkMode = (savedThemeState === 'true');
    document.body.classList.toggle('dark-mode', isDarkMode);
    document.getElementById('btn_dark').classList.toggle('active', isDarkMode);
    document.getElementById('btn_light').classList.toggle('active', !isDarkMode);

    // Set default device view
    setDevice('desktop');
    
    let percentage = 0;
    const duration = 5000; // 5 soniya
    const intervalTime = 50; // Har 50ms da yangilash
    const steps = duration / intervalTime;
    const increment = 100 / steps;

    const interval = setInterval(() => {
        percentage += increment;
        if (percentage >= 100) {
            percentage = 100;
            clearInterval(interval);
            setTimeout(() => {
                loader.style.opacity = '0';
                loader.style.visibility = 'hidden';
            }, 500);
        }
        
        // Update UI
        progressText.innerText = Math.round(percentage) + "%";
        // 360 daraja * foiz / 100
        const degrees = (percentage / 100) * 360;
        progressCircle.style.setProperty('--progress', degrees + 'deg');
    }, intervalTime);
});

// Agar kalit yo'q bo'lsa yoki placeholder bo'lsa, zaxira kalitni (WeatherAPI) ishlatamiz
if (!apiKey || apiKey === "OPENWEATHER_API_KEYINGIZ") {
    apiKey = "ff551288f31542a8bd7181253261602";
}

// Tarjimalar
const translations = {
    uz: {
        title: "üå§ Ob-havo",
        placeholder: "Shahar nomi...",
        btn: "Ko‚Äòrish",
        device: "Qurilma",
        theme: "Mavzu",
        lang: "Til",
        error_empty: "‚ùó Shahar nomini kiriting",
        error_not_found: "‚ùå Shahar topilmadi",
        error_net: "‚ö† Internet xatosi",
        humidity: "Namlik",
        wind: "Shamol",
        feels_like: "His qilinishi",
        uv_index: "UV Indeks",
        visibility: "Ko'rinish",
        wind_dir: "Shamol yo'n.",
        lbl_device: "Qurilma",
        lbl_theme: "Mavzu",
        lbl_lang: "Til",
        lbl_sound: "Ovoz",
        g_storm_watch: "Magnit bo'roni kutilmoqda",
        loc_access: "üìç Joylashuvni aniqlash...",
        loc_denied: "‚ùå Joylashuvga ruxsat berilmadi"
    },
    ru: {
        title: "üå§ –ü–æ–≥–æ–¥–∞",
        placeholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞...",
        btn: "–ü–æ–∫–∞–∑–∞—Ç—å",
        device: "–£—Å—Ç—Ä-–≤–æ",
        theme: "–¢–µ–º–∞",
        lang: "–Ø–∑—ã–∫",
        error_empty: "‚ùó –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞",
        error_not_found: "‚ùå –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω",
        error_net: "‚ö† –û—à–∏–±–∫–∞ —Å–µ—Ç–∏",
        humidity: "–í–ª–∞–∂–Ω–æ—Å—Ç—å",
        wind: "–í–µ—Ç–µ—Ä",
        feels_like: "–û—â—É—â–∞–µ—Ç—Å—è",
        uv_index: "–£–§-–∏–Ω–¥–µ–∫—Å",
        visibility: "–í–∏–¥–∏–º–æ—Å—Ç—å",
        wind_dir: "–ù–∞–ø—Ä. –≤–µ—Ç—Ä–∞",
        lbl_device: "–£—Å—Ç—Ä-–≤–æ",
        lbl_theme: "–¢–µ–º–∞",
        lbl_lang: "–Ø–∑—ã–∫",
        lbl_sound: "–ó–≤—É–∫",
        g_storm_watch: "–û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è",
        loc_access: "üìç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...",
        loc_denied: "‚ùå –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω"
    },
    en: {
        title: "üå§ Weather",
        placeholder: "City name...",
        btn: "Check",
        device: "Device",
        theme: "Theme",
        lang: "Lang",
        error_empty: "‚ùó Enter city name",
        error_not_found: "‚ùå City not found",
        error_net: "‚ö† Network error",
        humidity: "Humidity",
        wind: "Wind",
        feels_like: "Feels like",
        uv_index: "UV Index",
        visibility: "Visibility",
        wind_dir: "Wind Dir.",
        lbl_device: "Device",
        lbl_theme: "Theme",
        lbl_lang: "Lang",
        lbl_sound: "Sound",
        g_storm_watch: "Geomagnetic storm watch",
        loc_access: "üìç Locating...",
        loc_denied: "‚ùå Location denied"
    }
};

let currentLang = 'uz';

function setLang(lang) {
    currentLang = lang;
    const t = translations[lang];
    
    document.getElementById('app_title').innerText = t.title;
    document.getElementById('city').placeholder = t.placeholder;
    document.getElementById('btn_check').innerText = t.btn;
    document.getElementById('lbl_device').innerText = t.lbl_device;
    document.getElementById('lbl_theme').innerText = t.lbl_theme;
    document.getElementById('lbl_lang').innerText = t.lbl_lang;
    
    // Til tugmasini aktiv qilish
    ['uz', 'ru', 'en'].forEach(l => {
        const btn = document.getElementById(`btn_lang_${l}`);
        if (btn) {
            btn.classList.toggle('active', l === lang);
        }
    });
    
    // Agar natija ko'rsatilgan bo'lsa, uni tozalash yoki yangilash mumkin
    document.getElementById('result').innerHTML = "";
}

function setDevice(mode) {
    const wrapper = document.getElementById('app-wrapper');
    const btnDesktop = document.getElementById('btn_desktop');
    const btnMobile = document.getElementById('btn_mobile');

    if (mode === 'mobile') {
        wrapper.classList.add('mobile-mode');
        btnMobile.classList.add('active');
        btnDesktop.classList.remove('active');
    } else {
        wrapper.classList.remove('mobile-mode');
        btnDesktop.classList.add('active');
        btnMobile.classList.remove('active');
    }
}

function setTheme(theme) {
    const isDarkMode = (theme === 'dark');
    document.body.classList.toggle('dark-mode', isDarkMode);
    localStorage.setItem('isDarkMode', isDarkMode);

    // Tugmalarni yangilash
    document.getElementById('btn_dark').classList.toggle('active', isDarkMode);
    document.getElementById('btn_light').classList.toggle('active', !isDarkMode);

    // Fonni yangilash
    if (currentWeatherConditionText) {
        updateBackgroundVideo(currentWeatherConditionText, currentWeatherIsDay);
    }
}

function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    panel.classList.toggle('active');
}

// Joylashuvni aniqlash
function getLocation() {
    const resultDiv = document.getElementById("result");
    const t = translations[currentLang];
    
    if (navigator.geolocation) {
        resultDiv.innerHTML = t.loc_access;
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                fetchWeather(lat, lon, true);
            },
            (error) => {
                resultDiv.innerHTML = t.loc_denied;
            }
        );
    } else {
        resultDiv.innerHTML = "Geolocation is not supported by this browser.";
    }
}

// Orqa fonni ob-havoga qarab o'zgartirish
function updateBackgroundVideo(conditionText, apiIsDay) {
    const videoEl = document.getElementById('bg-video');
    const text = conditionText.toLowerCase();
    let newSrc = "";

    const isDarkModeActive = document.body.classList.contains('dark-mode');
    const effectiveIsDay = apiIsDay && !isDarkModeActive; // If API says day, but dark mode is active, treat as night for video selection

    // Aniq ob-havo uchun video havolalari (HD 1080p)
    const videos = {
        thunder: "https://videos.pexels.com/video-files/6992288/6992288-hd_1920_1080_25fps.mp4",
        rainDay: "https://videos.pexels.com/video-files/1732934/1732934-hd_1920_1080_30fps.mp4",
        rainNight: "https://videos.pexels.com/video-files/8033595/8033595-hd_1920_1080_25fps.mp4",
        snow: "https://videos.pexels.com/video-files/3253429/3253429-hd_1920_1080_25fps.mp4", // Kun/tun uchun mos
        fogDay: "https://videos.pexels.com/video-files/2833497/2833497-hd_1920_1080_25fps.mp4",
        fogNight: "https://videos.pexels.com/video-files/5432943/5432943-hd_1920_1080_25fps.mp4",
        cloudsDay: "https://videos.pexels.com/video-files/855344/855344-hd_1920_1080_24fps.mp4",
        cloudsNight: "https://videos.pexels.com/video-files/5794557/5794557-hd_1920_1080_25fps.mp4",
        clearDay: "https://videos.pexels.com/video-files/853871/853871-hd_1920_1080_25fps.mp4",
        clearNight: "https://videos.pexels.com/video-files/3121459/3121459-hd_1920_1080_25fps.mp4" // Shahar tuni (chiroqlar)
    };

    if (text.includes("thunder") || text.includes("chaqmoq")) {
        newSrc = videos.thunder;
    } else if (text.includes("rain") || text.includes("drizzle") || text.includes("yomg'ir")) {
        newSrc = effectiveIsDay ? videos.rainDay : videos.rainNight;
    } else if (text.includes("snow") || text.includes("qor") || text.includes("blizzard")) {
        newSrc = videos.snow; // Bu video kun va tun uchun mos keladi
    } else if (text.includes("mist") || text.includes("fog") || text.includes("tuman")) {
        newSrc = effectiveIsDay ? videos.fogDay : videos.fogNight;
    } else if (text.includes("cloud") || text.includes("overcast") || text.includes("bulut")) {
        newSrc = effectiveIsDay ? videos.cloudsDay : videos.cloudsNight;
    } else if (!effectiveIsDay) { // Ochiq tun
        newSrc = videos.clearNight;
    } else {
        // Ochiq kun (default)
        newSrc = videos.clearDay;
    }

    // Agar video o'zgargan bo'lsa, yangilash
    if (videoEl.src !== newSrc) {
        videoEl.style.opacity = 0; // Sekin o'tish uchun
        setTimeout(() => {
            videoEl.src = newSrc;
            videoEl.load();
            videoEl.playbackRate = 0.6; // Videoni yanada sekinlashtirish
            const playPromise = videoEl.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    videoEl.style.opacity = 1;
                }).catch(error => {
                    console.warn("Video avtomatik ijro etilmadi. Bu ovozli videolar uchun normal holat.", error); // Ovoz bloklanganda
                    videoEl.style.opacity = 1;
                });
            }
        }, 500);
    }
}

// Magnit bo'roni ma'lumotini olish
async function getGeomagneticStormInfo() {
    const stormDiv = document.getElementById('geomagnetic-storm-info');
    const t = translations[currentLang];
    try {
        const response = await fetch('https://services.swpc.noaa.gov/products/alerts.json');
        const alerts = await response.json();
        const stormAlert = alerts.find(alert => alert.message.includes('Geomagnetic Storm Watch'));
        
        if (stormAlert) {
            stormDiv.innerText = `üõ∞Ô∏è ${t.g_storm_watch}`;
            stormDiv.style.display = 'block';
        } else {
            stormDiv.style.display = 'none';
        }
    } catch (error) {
        console.error("Geomagnetic storm fetch error:", error);
        stormDiv.style.display = 'none';
    }
}

async function getWeather() {
    const city = document.getElementById("city").value;
    const resultDiv = document.getElementById("result");
    const t = translations[currentLang];

    if (!city) {
        // Agar shahar yozilmagan bo'lsa, avtomatik joylashuvni so'rash
        getLocation();
        return;
    }
    
    fetchWeather(city, null, false);
}

async function fetchWeather(query, lon, isCoords) {
    const resultDiv = document.getElementById("result");
    const t = translations[currentLang];
    getGeomagneticStormInfo(); // Magnit bo'roni tekshiruvini chaqirish
    
    // WeatherAPI.com dan foydalanamiz
    let url = "";
    const q = isCoords ? `${query},${lon}` : query;
    
    // Forecast endpoint orqali kunlik ma'lumot (sunrise/sunset uchun)
    url = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${q}&days=1&aqi=no&alerts=no&lang=${currentLang}`;

    try {
        const response = await fetch(url);

        if (!response.ok) {
            const errData = await response.json();
            const errMsg = errData.error?.message || "Unknown error";
            console.error("API Error:", errMsg);

            if (response.status === 400 && !isCoords) {
                resultDiv.innerHTML = `${t.error_not_found}<br><br><button class="location-btn" onclick="getLocation()" style="width:100%">${t.loc_access.replace('...', '')}</button>`;
            } else {
                resultDiv.innerHTML = `‚ùå <b>Xatolik (${response.status}):</b><br>${errMsg}`;
            }
            return;
        }

        const data = await response.json();
        const current = data.current;
        const location = data.location;
        currentWeatherConditionText = current.condition.text;
        currentWeatherIsDay = current.is_day;
        
        // Fonni yangilash
        updateBackgroundVideo(current.condition.text, current.is_day);

        resultDiv.innerHTML = `
            <h2>${location.name}, ${location.country}</h2>
            <h1>${Math.round(current.temp_c)}¬∞C</h1>
            <p>${current.condition.text}</p>
            
            <div class="details-grid">
                <div>üå° ${t.feels_like}: ${Math.round(current.feelslike_c)}¬∞C</div>
                <div>üíß ${t.humidity}: ${current.humidity}%</div>
                <div>üí® ${t.wind}: ${(current.wind_kph / 3.6).toFixed(1)} m/s</div>
                <div>üß≠ ${t.wind_dir}: ${current.wind_dir}</div>
                <div>‚òÄÔ∏è ${t.uv_index}: ${current.uv}</div>
                <div>üëÅÔ∏è ${t.visibility}: ${current.vis_km} km</div>
            </div>
        `;

    } catch (error) {
        resultDiv.innerHTML = `${t.error_net}<br><small>${error.message}</small>`;
        console.error(error);
    }
}

// Telegram Web App SDK ni ishga tushirish
if (window.Telegram?.WebApp) {
    window.Telegram.WebApp.ready();          // Ilova tayyorligini bildirish
    window.Telegram.WebApp.expand();         // Ilovani to'liq ekranga yoyish
    try {
        window.Telegram.WebApp.requestFullscreen(); // To'liq ekran rejimi (agar mavjud bo'lsa)
    } catch (e) {}
}

// Boshlang'ich sozlamalar
setLang('uz');

</script>

</body>
</html>
